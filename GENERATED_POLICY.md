# Generated Code Policy

This document defines the rules for generated vs. handwritten code in `rs-torn-client`.

## What is generated?

| Path | Source | Generator |
|------|--------|-----------|
| `openapi/latest.json` | Fetched from Torn API | `scripts/fetch_spec.py` |
| `openapi/spec_map.json` | Derived from spec | `scripts/regen.py` |
| `openapi/pagination_map.json` | Derived from spec | `scripts/regen.py` |
| `crates/torn_models/src/generated/**` | Derived from spec | `scripts/regen.py` |

## What is handwritten?

Everything else, including:

- `crates/torn_client/` — the ergonomic client layer
- `scripts/` — the generator/pipeline code itself
- `tests/` — integration and unit tests
- Documentation files
- CI configuration

## Rules

### 1. Never hand-edit generated files

Files in `crates/torn_models/src/generated/` and `openapi/*.json` are
machine-generated. **Do not edit them by hand.** Any manual changes will be
overwritten on the next regeneration.

### 2. Fixing generated output

If the generated code has a bug or needs adjustment, fix it through one of:

1. **Generator configuration** — Modify the codegen logic in `scripts/regen.py`
   (or future dedicated generator scripts) so it produces the correct output.

2. **Deterministic patch step** — Add a post-generation patch to `scripts/regen.py`
   that applies a deterministic transformation. The patch must:
   - Be scripted (no manual steps)
   - Be idempotent (running twice = same result)
   - Be documented with a comment explaining why it exists

### 3. CI enforcement

The `regen_check` CI workflow enforces this policy:

```
python scripts/regen.py
git diff --exit-code
```

If regeneration produces any diff, the CI job fails. This means:

- Generated files in the repo must always match what the pipeline produces.
- You must run `python scripts/regen.py` locally and commit the results.
- No "manual fixups" can sneak in.

### 4. Generated file markers

All generated Rust files must begin with this header:

```rust
// =============================================================================
// AUTO-GENERATED — DO NOT EDIT
// =============================================================================
// This module is generated by the regen pipeline (scripts/regen.py).
// Any manual changes will be overwritten on the next regeneration.
// ...
// =============================================================================
```

### 5. Spec caching

`openapi/latest.json` is committed to the repo for two reasons:

1. CI can diff against it to detect spec changes.
2. Developers can inspect the spec without re-fetching.

However, the regen pipeline always re-fetches the latest spec. The committed
version is the result of the most recent regen run.

## Regeneration Command

```bash
python scripts/regen.py
```

This single command:
1. Fetches the latest OpenAPI spec
2. Builds `spec_map.json` and `pagination_map.json`
3. Generates all Rust model code
4. Writes everything to the correct locations

Run this whenever:
- The Torn API spec changes
- The generator logic is updated
- CI tells you the regen check failed
